<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identity & Social</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üîê Identity & Social</h1>
            <p class="text-white/80">–°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
        </header>

        <!-- Status Card -->
        <div class="max-w-md mx-auto mb-6">
            <div class="card rounded-xl shadow-xl p-4">
                <div class="flex items-center justify-between">
                    <span class="font-semibold">–°—Ç–∞—Ç—É—Å API:</span>
                    <span id="apiStatus" class="px-3 py-1 rounded-full text-sm bg-gray-200">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="max-w-md mx-auto">
            <div class="card rounded-xl shadow-xl overflow-hidden">
                <!-- Tabs -->
                <div class="flex border-b">
                    <button onclick="showTab('login')" id="loginTab" class="flex-1 py-3 px-4 font-semibold text-purple-600 border-b-2 border-purple-600">
                        –í—Ö–æ–¥
                    </button>
                    <button onclick="showTab('register')" id="registerTab" class="flex-1 py-3 px-4 font-semibold text-gray-500 hover:text-purple-600">
                        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </button>
                    <button onclick="showTab('profile')" id="profileTab" class="flex-1 py-3 px-4 font-semibold text-gray-500 hover:text-purple-600">
                        –ü—Ä–æ—Ñ–∏–ª—å
                    </button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Username –∏–ª–∏ Email</label>
                            <input type="text" id="loginUsername" required
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ username –∏–ª–∏ email">
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="loginPassword" required
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                        </div>
                        <button type="submit"
                            class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition font-semibold">
                            –í–æ–π—Ç–∏
                        </button>
                    </form>
                    <div class="mt-4 text-center text-sm text-gray-600">
                        <p>–¢–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç: <strong>admin</strong> / <strong>Admin123!</strong></p>
                    </div>
                </div>

                <!-- Register Form -->
                <div id="registerForm" class="p-6 hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                    <form onsubmit="handleRegister(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                            <input type="text" id="regUsername" required minlength="3"
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                            <input type="email" id="regEmail" required
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="email@example.com">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="regPassword" required minlength="8"
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã">
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">–ò–º—è</label>
                                <input type="text" id="regFirstName"
                                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    placeholder="–ò–º—è">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">–§–∞–º–∏–ª–∏—è</label>
                                <input type="text" id="regLastName"
                                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    placeholder="–§–∞–º–∏–ª–∏—è">
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition font-semibold">
                            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </button>
                    </form>
                </div>

                <!-- Profile -->
                <div id="profileForm" class="p-6 hidden">
                    <div id="profileContent" class="text-center">
                        <p class="text-gray-600">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</p>
                    </div>
                </div>
            </div>

            <!-- Response Card -->
            <div class="mt-6 card rounded-xl shadow-xl p-4">
                <h3 class="font-bold text-gray-800 mb-2">üì§ –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç API:</h3>
                <pre id="responseBox" class="bg-gray-100 p-3 rounded-lg text-sm overflow-auto max-h-64 text-gray-700">
–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç–≤–µ—Ç
                </pre>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-8 text-white/60 text-sm">
            <p>Identity & Social API v0.0.1 | Backend: http://localhost:8083</p>
        </footer>
    </div>

    <script>
        const API_URL = 'http://localhost:8083';
        let accessToken = localStorage.getItem('accessToken');
        let refreshToken = localStorage.getItem('refreshToken');

        // Check API status on load
        checkApiStatus();
        if (accessToken) {
            loadProfile();
        }

        async function checkApiStatus() {
            const statusEl = document.getElementById('apiStatus');
            try {
                const response = await fetch(`${API_URL}/`);
                if (response.ok) {
                    statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    statusEl.className = 'px-3 py-1 rounded-full text-sm bg-green-100 text-green-800';
                } else {
                    throw new Error('API error');
                }
            } catch (e) {
                statusEl.textContent = '‚ùå –ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω';
                statusEl.className = 'px-3 py-1 rounded-full text-sm bg-red-100 text-red-800';
            }
        }

        function showTab(tab) {
            // Hide all forms
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('profileForm').classList.add('hidden');

            // Remove active from all tabs
            document.getElementById('loginTab').classList.remove('text-purple-600', 'border-b-2', 'border-purple-600');
            document.getElementById('registerTab').classList.remove('text-purple-600', 'border-b-2', 'border-purple-600');
            document.getElementById('profileTab').classList.remove('text-purple-600', 'border-b-2', 'border-purple-600');

            document.getElementById('loginTab').classList.add('text-gray-500');
            document.getElementById('registerTab').classList.add('text-gray-500');
            document.getElementById('profileTab').classList.add('text-gray-500');

            // Show selected
            document.getElementById(tab + 'Form').classList.remove('hidden');
            document.getElementById(tab + 'Tab').classList.remove('text-gray-500');
            document.getElementById(tab + 'Tab').classList.add('text-purple-600', 'border-b-2', 'border-purple-600');
        }

        function showResponse(data, isError = false) {
            const box = document.getElementById('responseBox');
            box.textContent = JSON.stringify(data, null, 2);
            box.className = `p-3 rounded-lg text-sm overflow-auto max-h-64 ${isError ? 'bg-red-50 text-red-800' : 'bg-green-50 text-green-800'}`;
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usernameOrEmail: username, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    accessToken = data.accessToken;
                    refreshToken = data.refreshToken;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    showResponse(data);
                    loadProfile();
                    showTab('profile');
                    alert('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    showResponse(data, true);
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'));
                }
            } catch (e) {
                showResponse({ error: e.message }, true);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:8083');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const data = {
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                firstName: document.getElementById('regFirstName').value || null,
                lastName: document.getElementById('regLastName').value || null
            };

            try {
                const response = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    accessToken = result.accessToken;
                    refreshToken = result.refreshToken;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    showResponse(result);
                    loadProfile();
                    showTab('profile');
                    alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                } else {
                    showResponse(result, true);
                    let errorMsg = result.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                    if (result.details) {
                        errorMsg += '\n' + Object.values(result.details).join('\n');
                    }
                    alert('‚ùå ' + errorMsg);
                }
            } catch (e) {
                showResponse({ error: e.message }, true);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API');
            }
        }

        async function loadProfile() {
            if (!accessToken) {
                document.getElementById('profileContent').innerHTML = '<p class="text-gray-600">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const user = await response.json();
                    showResponse(user);
                    document.getElementById('profileContent').innerHTML = `
                        <div class="text-center">
                            <div class="w-20 h-20 bg-purple-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                                <span class="text-3xl text-white">${user.username[0].toUpperCase()}</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">${user.fullName || user.username}</h3>
                            <p class="text-gray-600">@${user.username}</p>
                            <p class="text-gray-500 text-sm">${user.email}</p>
                            <div class="mt-4 flex flex-wrap justify-center gap-2">
                                ${user.roles.map(r => `<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">${r}</span>`).join('')}
                            </div>
                            <p class="text-gray-400 text-xs mt-4">UUID: ${user.uuid}</p>
                            <button onclick="handleLogout()" class="mt-6 bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition">
                                –í—ã–π—Ç–∏
                            </button>
                        </div>
                    `;
                } else {
                    // Token expired
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    accessToken = null;
                    document.getElementById('profileContent').innerHTML = '<p class="text-gray-600">–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.</p>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function handleLogout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            accessToken = null;
            refreshToken = null;
            showTab('login');
            document.getElementById('profileContent').innerHTML = '<p class="text-gray-600">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</p>';
            showResponse({ message: '–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã' });
            alert('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        }
    </script>
</body>
</html>

